COLOR_COUNT_MAPPING = {
  2389 => '1', 2390 => '1', 2401 => '1', 3085 => '1', 3086 => '1', 6557 => '1', 7050 => '1',
  7357 => '3', 6533 => '1', 6534 => '1', 7303 => '7', 1446 => '1', 1462 => '1', 1496 => '1',
  1543 => '1', 1559 => '1', 1947 => '1', 1748 => '1', 1749 => '1', 1750 => '1', 1751 => '1',
  2083 => '1', 2084 => '1', 2085 => '1', 2086 => '1', 2090 => '1', 2091 => '1', 2092 => '1',
  2093 => '1', 1766 => '2', 1767 => '1', 2003 => '4', 2124 => '1', 2181 => '2', 2334 => '3',
  2371 => '1', 2372 => '1', 2566 => '1', 2567 => '1', 2568 => '1', 2683 => '1', 5231 => '1',
  15128 => '2', 6941  => '1', 7482  => '6', 7171  => '3', 8622  => '3', 1310  => '2', 1312  => '1',
  1313  => '1', 1321  => '2', 1329  => '2', 1342  => '4', 1477  => '1', 1655  => '3', 1825  => '1',
  2212  => '1', 2214  => '1', 2216  => '1', 4403  => '1', 9986  => '3', 1002  => '1', 1011  => '2',
  1450  => '1', 1451  => '2', 1454  => '3', 1473  => '1', 1624  => '5', 2336  => '2', 2534  => '6',
  2555  => '6', 3945  => '1', 4107  => '8', 4211  => '1', 4978  => '1', 5506  => '4', 5527  => '3',
  6576  => '5', 6664  => '2', 6546  => '5', 6731  => '6', 6536  => '2', 6531  => '2', 6532  => '1',
  19031 => '5', 9877  => '4', 10320 => '4', 12252 => '8', 13124 => '5', 13125 => '5', 1949  => '5',
  1967  => '2', 1968  => '2', 1976  => '2', 1977  => '2', 1978  => '2', 1979  => '2', 1986  => '3',
  1991  => '2', 2059  => '2', 2133  => '1', 2134  => '1', 2135  => '1', 2136  => '1', 2138  => '1',
  2137  => '1', 2275  => '3', 2276  => '3', 2400  => '2', 2439  => '2', 2451  => '2', 2452  => '2',
  2637  => '3', 2821  => '2', 2829  => '3', 3151  => '1', 4203  => '9', 5185  => '2', 5188  => '2',
  5286  => '2', 5291  => '3', 5793  => '2', 5794  => '2', 5871  => '4', 5872  => '1', 5873  => '1',
  5874  => '2', 5875  => '2', 5876  => '2', 5878  => '1', 5897  => '1', 5940  => '4', 5941  => '3',
  6580  => '4', 6549  => '3', 6593  => '4', 6797  => '2', 6716  => '8', 6719  => '3', 8795  => '9',
  6430  => '1', 6431  => '1', 15406 => '1', 15409 => '3', 1437  => '1', 1438  => '1', 1439  => '1',
  1441  => '1', 1525  => '1', 1526  => '1', 1550  => '2', 1615  => '1', 1645  => '1', 1646  => '1',
  1773  => '2', 1819  => '1', 1830  => '1', 1831  => '1', 1832  => '1', 1856  => '1', 1858  => '1',
  1919  => '2', 1926  => '1', 1945  => '2', 1970  => '1', 2378  => '1', 2050  => '1', 2051  => '1',
  2141  => '2', 2176  => '3', 2162  => '2', 2194  => '2', 2195  => '1', 2244  => '1', 2252  => '1',
  2253  => '1', 2274  => '7', 2292  => '1', 2331  => '1', 2364  => '1', 2515  => '1', 2539  => '1',
  2542  => '1', 2554  => '2', 11879 => '6', 1015  => '2', 1062  => '1', 1258  => '1', 1306  => '1',
  1307  => '1', 1324  => '1', 1325  => '1', 1610  => '6', 1564  => '1', 1565  => '1', 1569  => '1',
  1573  => '1', 1574  => '1', 1580  => '1', 1704  => '1', 1706  => '2', 1768  => '1', 1769  => '1',
  1770  => '1', 1917  => '1', 1918  => '1', 2172  => '2', 2210  => '1', 2478  => '1', 2366  => '1',
  2763  => '1', 3047  => '2', 2830  => '1', 6727  => '1', 6728  => '1', 7994  => '1', 9253  => '5',
  1254  => '2', 1255  => '2', 1272  => '2', 1290  => '1', 1382  => '1', 1383  => '1', 1384  => '1',
  2582  => '1', 3501  => '1', 1435  => '1', 1456  => '2', 1465  => '2', 1466  => '1', 1528  => '1',
  1541  => '7', 1771  => '4', 1772  => '3', 1782  => '7', 1938  => '3', 2022  => '4', 2106  => '1',
  2115  => '1', 2302  => '2', 2681  => '1', 2977  => '7', 3311  => '1', 4551  => '1', 3537  => '4',
  7581  => '7', 8449  => '4', 15429 => '1', 1227  => '2', 4874  => '1', 4575  => '2', 4738  => '3',
  4848  => '2', 4849  => '2', 4850  => '2', 4873  => '1', 1628  => '1', 1629  => '1', 1631  => '1',
  1905  => '1', 1906  => '1', 3567  => '1', 3570  => '2'
}

BAD_IMPRINT_FILE = Rails.root.join('bad-imprints.txt').to_s

namespace :imprints do
  def option_value_for(option_type, value)
    cache = (@option_value_cache[option_type.id] ||= {})

    return cache[value] if cache.key?(value)

    cache[value] = option_type.option_values.find_by(value: value)
  end

  def first_option_for(option_type)
    cache = (@option_value_cache[option_type.id] ||= {})

    cache[:first] ||= option_type.option_values.first
  end

  desc "Set option values on imprints that don't have any"
  task set_default_option_values: :environment do
    File.open(BAD_IMPRINT_FILE, 'w') { |f| f.write("BAD IMPRINTS:\n\n") }

    imprint_method_cache = {}
    count = 0
    total_time = 0
    @option_value_cache = {}

    Imprint.includes(:option_values).find_each do |imprint|
      imprint_method = (imprint_method_cache[imprint.print_location_id] ||= imprint.imprint_method)

      next if imprint_method.nil?                ||
              imprint_method.option_types.empty? ||
              imprint.option_values.size >= imprint_method.option_types.size

      before_time = Time.now

      skip_this_imprint = false
      imprint_method.option_types.each do |option_type|
        if option_type.name == 'Color Count'
          value = COLOR_COUNT_MAPPING[imprint.id]

          if value.blank?
            # Try for N/A
            option_value = option_value_for(option_type, "N/A")

            if option_value.nil?
              # Parse Imprint description
              if imprint.description
                if /(?<color_count>\d+)-[Cc]/ =~ imprint.description
                  option_value = option_value_for(option_type, color_count)
                elsif /(?<color_count>\d+)\s*[cC]olor/ =~ imprint.description
                  option_value = option_value_for(option_type, color_count)
                end
              end
            end

            # if it's still nil, report this imprint
            if option_value.nil?
              if imprint.job.jobbable_type == 'Quote'
                option_value = first_option_for(option_type)
              else
                File.open(BAD_IMPRINT_FILE, 'a') do |f|
                  f.write("https://crm.softwearcrm.com/jobs/#{imprint.job_id}  Imprint ##{imprint.id}\n")
                  skip_this_imprint = true
                end
              end
            end
          else
            option_value = option_value_for(option_type, value)
          end

          next if option_value.blank?
          imprint.selected_option_values[option_type.id] = option_value.id

        else
          # For non-color count option types:
          option_value = option_value_for(option_type, "N/A") || first_option_for(option_type)

          imprint.selected_option_values[option_type.id] = option_type.option_value_ids.first
        end
      end

      begin
        if !imprint.save && !skip_this_imprint
          File.open(BAD_IMPRINT_FILE, 'a') do |f|
            f.write("\nFAILED TO SAVE IMPRINT ##{imprint.id}: #{imprint.errors.full_messages}\n\n")
          end
        end
      rescue StandardError => e
        File.open(BAD_IMPRINT_FILE, 'a') do |f|
          f.write("\nERROR DURING SAVE ##{imprint.id}: #{e.class} #{e.message}\n#{e.backtrace.first(5).join("\n")}\n\n")
        end
      end

      after_time = Time.now
      total_time += (after_time - before_time)

      count += 1
      if count % 50 == 0
        puts "  Processed #{count} imprints... (#{count / total_time} imprints per second) #{total_time} seconds have passed"
      end
    end
  end
end