var discountHtml = "<br/><%= j(render 'discounts/form').html_safe %>";

var setContent = function() {
  $('#discount-form').html(discountHtml);
  $('#discount-form').data('current', "<%=j params[:form] %>");
  setTimeout(function() { $('#discount-form').collapse('show'); }, 100);
  $('#discount-form').off('hidden.bs.collapse', setContent);

  <% # Special logic for refund form (select different discountable types) %>
  <% if params[:form] == 'refund' %>
    var paymentSelect = $('.refund-payment-select');
    var jobSelect     = $('.refund-job-select');
    var hideSelect = function(select) {
      select.hide();
      select.find('input,select').each(function() { $(this).prop('disabled', true); });
    }
    var showSelect = function(select) {
      select.show();
      select.find('input,select').each(function() { $(this).prop('disabled', false); });
    }
    var orderId = $('#discountable-order-id');

    var setTransactionId = function() {
      var pSelect = paymentSelect.find('select');

      var selector = 'option[value="'+pSelect.val()+'"]';
      var transaction = pSelect.find(selector).data('transaction');

      if (transaction && transaction != '')
        $('#discount_transaction_id').val(transaction);
    };

    var setSelectVisibility = function() {
      var select = $(this);

      if (select.val() == 'Job') {
        hideSelect(paymentSelect);
        showSelect(jobSelect);
        orderId.prop('disabled', true);
      }
      else if (select.val() == 'Payment') {
        showSelect(paymentSelect);
        hideSelect(jobSelect);
        orderId.prop('disabled', true);

        setTimeout(setTransactionId, 10);
      }
      else {
        hideSelect(paymentSelect);
        hideSelect(jobSelect);
        orderId.prop('disabled', false);
      }
    };

    $('#discount_discountable_type').change(setSelectVisibility);

    paymentSelect.change(setTransactionId);

    setTimeout(function() { setSelectVisibility.call($('#discount_discountable_type')); }, 50);
  <% end %>
}

if ($('#discount-form').data('current') != null) {
  if ($('#discount-form').data('current') == "<%=j params[:form] %>") {
    <% if @scroll %>
      $('#discount-form').on('hidden.bs.collapse', setContent);
    <% else %>
      $('#discount-form').data('current', null);
    <% end %>

    $('#discount-form').collapse('hide');
  }
  else {
    $('#discount-form').on('hidden.bs.collapse', setContent);
    $('#discount-form').collapse('hide');
  }
}
else {
  setContent();
}

<% if @scroll %>
  var doScroll = function() {
    $('.scroll-y').scrollTo(
      '#discount-form',
      {
        duration: 1000,
        offsetTop: 85
      },

      function() {
        <% if @payment %>
          $('#discount_amount').val(<%= @payment.amount %>);
        <% end %>
        $('#discount_amount').focus();
        shine('#discount_amount', true, 1000, '#FFFF00');
      }
    );
  }
  setTimeout(doScroll, 100);
<% end %>
