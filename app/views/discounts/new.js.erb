var discountHtml = "<br/><%= j(render 'form').html_safe %>";

var setContent = function() {
  $('#discount-form').html(discountHtml);
  $('#discount-form').data('current', "<%=j params[:form] %>");
  setTimeout(function() { $('#discount-form').collapse('show'); }, 100);
  $('#discount-form').off('hidden.bs.collapse', setContent);

  <% if params[:form] == 'refund' %>
    var paymentSelect = $('.refund-payment-select');
    var jobSelect     = $('.refund-job-select');
    var hideSelect = function(select) {
      select.hide();
      select.find('input,select').each(function() { $(this).disable(); });
    }
    var showSelect = function(select) {
      select.show();
      select.find('input,select').each(function() { $(this).enable(); });
    }
    var setTransactionId = function() {
      var pSelect = paymentSelect.find('select');

      var selector = 'option[value="'+pSelect.val()+'"]';
      console.log(selector)
      var transaction = pSelect.find(selector).data('transaction');

      if (transaction && transaction != '')
        $('#discount_transaction_id').val(transaction);
    };

    $('#discount_discountable_type').change(function() {
      var select = $(this);

      console.log('SELECTED '+select.val());
      if (select.val() == 'Job') {
        hideSelect(paymentSelect);
        showSelect(jobSelect);
      }
      else if (select.val() == 'Payment') {
        showSelect(paymentSelect);
        hideSelect(jobSelect);

        setTransactionId();
      }
      else {
        hideSelect(paymentSelect);
        hideSelect(jobSelect);
      }
    });

    paymentSelect.change(setTransactionId);
  <% end %>
}

if ($('#discount-form').data('current') != null) {
  if ($('#discount-form').data('current') == "<%=j params[:form] %>") {
    $('#discount-form').collapse('hide');
    $('#discount-form').data('current', null);
  }
  else {
    $('#discount-form').on('hidden.bs.collapse', setContent);
    $('#discount-form').collapse('hide');
  }
}
else {
  setContent();
}
